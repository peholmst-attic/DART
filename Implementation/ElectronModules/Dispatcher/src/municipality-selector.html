<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">

<dom-module id="municipality-selector">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: inline-block;
            }
            #input {
                width: calc(100% - 26px);
            }
            #result {
                display: block;
                position: absolute;
                box-shadow: 5px 5px 5px rgba(0,0,0,.075);
            }
            #result.hidden {
                visibility: hidden;
            }
        </style>
        <input type="text" id="input" value="{{_namePrefix::input}}" on-keydown="_handleInputKeyDown"/>
        <select id="result" size="3" class="hidden" on-keydown="_handleResultKeyDown">
            <template is="dom-repeat" items="{{_municipalities}}">
                <option value="{{item.id}}">{{item.name_fi}} - {{item.name_sv}}</option>
            </template>
        </select>
    </template>
    <script>
        Polymer({
            is: 'municipality-selector',

            _mapService: null,

            properties: {
                _namePrefix: {
                    type: String,
                    observer: '_namePrefixChanged'
                },
                _municipalities: {
                    type: Array,
                    observer: '_municipalitiesChanged'
                },
                value: {
                    type: Number,
                    observer: '_valueChanged'
                }
            },

            get mapService() {
                if (!this._mapService) {
                    throw 'The document does not have a <map-service> element';
                } else {
                    return this._mapService;
                }
            },

            set mapService(mapService) {
                this._mapService = mapService;
            },

            ready: function() {
                this.mapService = document.querySelector('map-service');
                this._isReady = true;
                this._valueChanged(this.value, null);
            },

            _handleInputKeyDown: function(event) {
                if (event.keyCode == '38') {
                    // up arrow
                    ix = this.$.result.selectedIndex -1;
                    if (ix < 0) {
                        ix = this.$.result.length -1;
                    }
                    this.$.result.selectedIndex = ix;
                    event.preventDefault();
                } else if (event.keyCode == '40') {
                    // down arrow
                    ix = this.$.result.selectedIndex +1;
                    if (ix >= this.$.result.length) {
                        ix = 0;
                    }
                    this.$.result.selectedIndex = ix;
                    event.preventDefault();
                } else if (event.keyCode == '13') {
                    // enter
                    this._setCurrentValueFromResultSelection();
                    this._toggleResultList(false);
                } else if (event.keyCode == '27') {
                    // escape
                    this._updateCurrentValueFromDatabase();
                    this._toggleResultList(false);
                }
            },

            _handleResultKeyDown: function(event) {

            },

            _namePrefixChanged: function(newValue, oldValue) {
                if (!this._updatingValue) {
                    this.mapService.findMunicipalities(newValue, function(result) {
                        this._municipalities = result;
                    }.bind(this));
                }
            },

            _municipalitiesChanged: function(newValue, oldValue) {
                this._toggleResultList(newValue.length > 0);
            },

            _valueChanged: function(newValue, oldValue) {
                if (this._isReady && newValue) {
                    this.mapService.findMunicipality(newValue, function(result) {
                        this._updatingValue = true;
                        if (result) {
                            this.$.input.value = result.name_fi + ' - ' + result.name_sv;
                        } else {
                            this.$.input.value = '';
                            this.value = null;
                        }
                        this._updatingValue = false;
                    }.bind(this));
                }
            },

            _setCurrentValueFromResultSelection: function() {
                this.value = this.$.result.value;
            },

            _updateCurrentValueFromDatabase: function() {
                this.mapService.findMunicipality(this.value, function(result) {
                    if (result) {
                        this.$.input.value = result.name_fi + ' - ' + result.name_sv;
                    } else {
                        this.$.input.value = '';
                        this.value = null;
                    }
                    this._updatingValue = false;
                }.bind(this));
            },

            _toggleResultList: function(visible) {
                if (visible) {
                    this.$.result.classList.remove('hidden');
                    this.$.result.style.width = this.$.input.offsetWidth + 'px';
                } else {
                    this.$.result.classList.add('hidden');
                }
            }
        });
    </script>
</dom-module>
